name: Auto-Generate Database Migration

on:
  push:
    branches:
      - main
    paths:
      - 'DatabaseProject/**/*.sql'
      - 'DatabaseProject/*.sqlproj'

jobs:
  generate-migration:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for comparison
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.1
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'
      
      - name: Install SqlPackage
        run: dotnet tool install -g microsoft.sqlpackage
      
      - name: Build current DACPAC
        run: |
          Write-Host "Building current DACPAC..."
          msbuild DatabaseProject/DatabaseProject.sqlproj `
            /p:Configuration=Release `
            /p:Platform=AnyCPU `
            /p:OutputPath=bin/Current/
        shell: pwsh
      
      - name: Get last release tag
        id: get_tag
        run: |
          # Get the last release tag or use initial commit
          $lastTag = git describe --tags --abbrev=0 --match "release/*" 2>$null
          if (-not $lastTag) {
            $lastTag = git rev-list --max-parents=0 HEAD
          }
          Write-Host "Last release tag: $lastTag"
          echo "last_tag=$lastTag" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Checkout previous release version
        run: |
          # Create a temporary directory for previous version
          New-Item -ItemType Directory -Force -Path "temp_previous"
          
          # Get files from last release
          git archive ${{ steps.get_tag.outputs.last_tag }} DatabaseProject | tar -x -C temp_previous
        shell: pwsh
      
      - name: Build previous DACPAC
        run: |
          Write-Host "Building previous DACPAC..."
          if (Test-Path "temp_previous/DatabaseProject.sqlproj") {
            msbuild temp_previous/DatabaseProject.sqlproj `
              /p:Configuration=Release `
              /p:Platform=AnyCPU `
              /p:OutputPath=../bin/Previous/
          } else {
            Write-Host "No previous version found, creating empty DACPAC"
            # Create empty database for first migration
            New-Item -ItemType Directory -Force -Path "bin/Previous"
          }
        shell: pwsh
      
      - name: Generate migration script
        id: generate
        run: |
          $timestamp = Get-Date -Format "yyyyMMddHHmmss"
          $migrationFile = "DatabaseProject/Migrations/V$timestamp`__auto_generated.sql"
          
          # Ensure Migrations directory exists
          New-Item -ItemType Directory -Force -Path "DatabaseProject/Migrations"
          
          Write-Host "Generating migration script..."
          
          # Check if previous DACPAC exists
          $previousDacpac = "DatabaseProject/bin/Previous/DatabaseProject.dacpac"
          $currentDacpac = "DatabaseProject/bin/Current/DatabaseProject.dacpac"
          
          if (Test-Path $previousDacpac) {
            # Generate diff using SqlPackage
            sqlpackage /Action:Script `
              /SourceFile:$currentDacpac `
              /TargetFile:$previousDacpac `
              /OutputPath:$migrationFile `
              /p:IncludeTransactionalScripts=True `
              /p:BlockOnPossibleDataLoss=False `
              /p:DropObjectsNotInSource=False `
              /p:IgnorePermissions=True `
              /p:IgnoreRoleMembership=True `
              /p:IgnoreUserSettingsObjects=True `
              /p:IgnoreLoginSids=True
          } else {
            Write-Host "First migration - extracting full schema"
            sqlpackage /Action:Script `
              /SourceFile:$currentDacpac `
              /OutputPath:$migrationFile `
              /p:IncludeTransactionalScripts=True
          }
          
          # Check if migration has meaningful content
          if ((Test-Path $migrationFile) -and ((Get-Item $migrationFile).Length -gt 200)) {
            Write-Host "Migration script generated successfully"
            echo "migration_created=true" >> $env:GITHUB_OUTPUT
            echo "migration_file=$migrationFile" >> $env:GITHUB_OUTPUT
            
            # Add header to migration
            $header = @"
/*
 * ============================================================================
 * AUTO-GENERATED MIGRATION SCRIPT
 * ============================================================================
 * Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
 * Commit: ${{ github.sha }}
 * Author: ${{ github.actor }}
 * Branch: ${{ github.ref_name }}
 * 
 * IMPORTANT: 
 * - Review this script before deploying to production
 * - Ensure database backup is completed
 * - Test on staging environment first
 * ============================================================================
 */

-- Environment and safety checks
DECLARE @DatabaseName NVARCHAR(128) = DB_NAME();
DECLARE @ServerName NVARCHAR(128) = @@SERVERNAME;

PRINT '============================================================================';
PRINT 'Starting Migration: V$timestamp';
PRINT 'Database: ' + @DatabaseName;
PRINT 'Server: ' + @ServerName;
PRINT 'Time: ' + CONVERT(VARCHAR, GETDATE(), 120);
PRINT '============================================================================';


PRINT '============================================================================';
PRINT 'Ensure backup is completed before proceeding!!!';
PRINT '============================================================================';

-- Check SQL Server version
DECLARE @Version NVARCHAR(128) = CAST(SERVERPROPERTY('ProductVersion') AS NVARCHAR(128));
PRINT 'SQL Server Version: ' + @Version;
PRINT '';

GO

"@
            $content = Get-Content $migrationFile -Raw
            $footer = @"

GO

-- Migration completion
PRINT '';
PRINT '============================================================================';
PRINT 'Migration V$timestamp completed successfully!';
PRINT 'Completed at: ' + CONVERT(VARCHAR, GETDATE(), 120);
PRINT '============================================================================';
GO
"@
            ($header + $content + $footer) | Set-Content $migrationFile
            
          } else {
            Write-Host "No significant changes detected"
            echo "migration_created=false" >> $env:GITHUB_OUTPUT
            if (Test-Path $migrationFile) { 
              Remove-Item $migrationFile 
            }
          }
        shell: pwsh
      
      - name: Create migration summary
        if: steps.generate.outputs.migration_created == 'true'
        run: |
          $migrationFile = "${{ steps.generate.outputs.migration_file }}"
          $content = Get-Content $migrationFile -Raw
          
          # Extract key changes (simplified)
          $summary = @"
          ## ðŸ”„ Database Migration Generated
          
          **File:** ``$migrationFile``
          **Size:** $((Get-Item $migrationFile).Length) bytes
          **Generated:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          
          ### Review Required
          - [ ] Review all schema changes
          - [ ] Check for potential data loss
          - [ ] Verify transaction handling
          - [ ] Test on staging environment
          - [ ] Ensure backup before production deployment
          "@
          
          $summary | Out-File -FilePath "migration_summary.md"
        shell: pwsh
      
      - name: Commit migration script
        if: steps.generate.outputs.migration_created == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add DatabaseProject/Migrations/
          git commit -m "chore: auto-generate migration script [skip ci]

          Generated from commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          
          This migration script was automatically generated by comparing
          the current schema with the last release version."
          git push
        shell: pwsh
      
      - name: Create PR comment (if applicable)
        if: steps.generate.outputs.migration_created == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('migration_summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
